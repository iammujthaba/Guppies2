{% extends 'store/Base.html' %}
{% load static %}
{% load video_tags %}

{% block content %}
<link rel="stylesheet" href="{% static 'assets/css/style/product.css' %}">

<main class="main">
    <nav aria-label="breadcrumb" class="breadcrumb-nav border-0 mb-0">
        <div class="container-fluid d-flex align-items-center">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'store_app:allProdCat' %}">Home</a></li>
                <li class="breadcrumb-item">{{product.name}}</li>
            </ol>
        </div>
    </nav>

    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xl-10">
                    <div class="product-details-top">
                        <div class="row">

                            <div class="col-md-6 col-lg-7">
                                <div class="product-gallery">
                                    <div class="icon-container">
                                        <div class="left-icons">
                                            <button class="icon-btn share-btn">
                                                <i class="fa-solid fa-share-nodes" style="font-size: 25px; font-weight: 800;"></i>
                                            </button>
                                        </div>
                                        <div class="right-icons">
                                            <button class="icon-btn heart-btn" id="wishlist-icon-{{ product.id }}" onclick="toggleWishlist({{ product.id }})">
                                                <i class="{% if in_wishlist %}fa-solid fa-heart{% else %}icon-heart-o{% endif %}" style="font-size: 30px; font-weight: 800; {% if in_wishlist %}color: red;{% endif %}"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <script>
                                        function toggleWishlist(productId) {
                                        const url = '{% url "store_app:add_to_wishlist" %}';
                                        const iconElement = document.getElementById(`wishlist-icon-${productId}`);
                                        const wishlistCountElement = document.getElementById('wishlist-count');

                                        fetch(url, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': '{{ csrf_token }}',
                                            },
                                            body: JSON.stringify({ 'productId': productId }),
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.added) {
                                                iconElement.innerHTML = '<i class="fa-solid fa-heart" style="font-size: 30px; font-weight: 800; color: red;"></i>';
                                            } else {
                                                iconElement.innerHTML = '<i class="icon-heart-o" style="font-size: 30px; font-weight: 800;"></i>';
                                            }
                                            wishlistCountElement.textContent = data.wishlist_count;

                                            // Update the wishlist count in the header
                                            const headerWishlistCount = document.querySelector('.wishlist .wishlist-count');
                                            if (headerWishlistCount) {
                                                headerWishlistCount.textContent = data.wishlist_count;
                                            }
                                        });
                                    }
                                    </script>
                                    
                                    <figure class="product-main-image">
                                        <div class="product-gallery">
                                            <figure class="product-main-image">
                                                <img src="{{ product.image_1.url }}" alt="product image" class="product-image">
                                            </figure>
                                        </div>
                                    </figure>
                                    <div class="carousel-indicators"></div>
                                </div>
                            
                                <script>
                                    var productData = {
                                        image1: "{{ product.image_1.url|escapejs }}",
                                        {% if product.image_2 %}
                                        image2: "{{ product.image_2.url|escapejs }}",
                                        {% endif %}
                                        {% if product.video_url %}
                                        videoUrl: "https://www.youtube.com/embed/{{ product.video_url|youtube_id|escapejs }}",
                                        {% endif %}
                                        {% if product.image_3 %}
                                        image3: "{{ product.image_3.url|escapejs }}"
                                        {% endif %}
                                    };
                                </script>
                            
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const carouselIndicators = document.querySelector('.carousel-indicators');
                                        const productMainImage = document.querySelector('.product-main-image img');
                                        let currentIndex = 0;
                                        let galleryItems = [];
                            
                                        function initializeGallery() {
                                            galleryItems = [
                                                { type: 'image', url: productData.image1 }
                                            ];
                            
                                            if (productData.image2) {
                                                galleryItems.push({ type: 'image', url: productData.image2 });
                                            }
                            
                                            if (productData.videoUrl) {
                                                galleryItems.push({ type: 'video', url: productData.videoUrl });
                                            }
                            
                                            if (productData.image3) {
                                                galleryItems.push({ type: 'image', url: productData.image3 });
                                            }
                            
                                            createIndicators();
                                            updateGallery(0);
                                        }
                            
                                        function createIndicators() {
                                            carouselIndicators.innerHTML = '';
                                            galleryItems.forEach((_, index) => {
                                                const indicator = document.createElement('button');
                                                indicator.setAttribute('type', 'button');
                                                indicator.addEventListener('click', () => updateGallery(index));
                                                carouselIndicators.appendChild(indicator);
                                            });
                                        }
                            
                                        function updateGallery(index) {
                                            const item = galleryItems[index];
                                            if (item.type === 'image') {
                                                productMainImage.src = item.url;
                                                productMainImage.style.display = 'block';
                                                document.querySelector('.responsive-video')?.remove();
                                            } else if (item.type === 'video') {
                                                productMainImage.style.display = 'none';
                                                const videoContainer = document.createElement('div');
                                                videoContainer.className = 'responsive-video';
                                                videoContainer.innerHTML = `<iframe src="${item.url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                                                productMainImage.parentNode.appendChild(videoContainer);
                                            }
                                            updateIndicators(index);
                                        }
                            
                                        function updateIndicators(activeIndex) {
                                            const indicators = carouselIndicators.querySelectorAll('button');
                                            indicators.forEach((indicator, index) => {
                                                indicator.classList.toggle('active', index === activeIndex);
                                            });
                                        }
                            
                                        function navigate(direction) {
                                            currentIndex += direction;
                                            if (currentIndex < 0) currentIndex = galleryItems.length - 1;
                                            if (currentIndex >= galleryItems.length) currentIndex = 0;
                                            updateGallery(currentIndex);
                                        }
                            
                                        let touchStartX = 0;
                                        let touchEndX = 0;
                            
                                        productMainImage.parentNode.addEventListener('touchstart', e => {
                                            touchStartX = e.changedTouches[0].screenX;
                                        });
                            
                                        productMainImage.parentNode.addEventListener('touchend', e => {
                                            touchEndX = e.changedTouches[0].screenX;
                                            handleSwipe();
                                        });
                            
                                        function handleSwipe() {
                                            if (touchEndX < touchStartX) navigate(1);
                                            if (touchEndX > touchStartX) navigate(-1);
                                        }
                            
                                        initializeGallery();
                                    });
                                </script>
                            </div>
                            
                            

                            <div class="col-md-6 col-lg-5">
                                <div class="product-details">

                                    
                                    <div class="col-md-8">
                                    
                                        <h3 class="mb-1">{{product.name}}</h3>
                                        <h5 class="text-muted">JEE Exam preprestion book</h5>
                                    
                                        <div class="d-flex align-items-center">
                                            <h3 class=" mb-0">₹{{product.new_price}}</h3>
                                            <!-- <span class="text-muted ml-2"><s>₹599</s></span> -->
                                            <h1 class="mb-0 ml-2">-</h1>
                                            {% if product.old_price == 0 %}
                                            {% else %}
                                            <h4 class="text-muted mb-0 ml-2"><s>₹{{product.old_price}}</s></h4>
                                            {% endif %}
                                            <!-- <span class="text-success ml-2 discount">48% off</span> -->
                                            {% if product.get_discounted_price %}
                                            <h4 class="text-success mb-0 ml-2">{{ product.get_discounted_price.percentage }}% off</h4>
                                            {% endif %}
                                        </div>
                                    
                                        <hr style="font-weight: 800px;" class="separator">
                                        <h6 style="margin-top: 20px;">Book Details</h6>
                                    
                                        <table class="table ">
                                            <tr>
                                                <th>Publisher</th>
                                                <td>DC Books</td>
                                            </tr>
                                            <tr>
                                                <th>Author</th>
                                                <td>Bittu Kumar</td>
                                            </tr>
                                            <tr>
                                                <th>Language</th>
                                                <td>Malayalam</td>
                                            </tr>
                                            <tr>
                                                <th>Edition</th>
                                                <td>2023</td>
                                            </tr>
                                            <tr>
                                                <th>Pages</th>
                                                <td>98</td>
                                            </tr>
                                            <tr>
                                                <th>Binding</th>
                                                <td>Paperback</td>
                                            </tr>
                                            <tr>
                                                <th>published</th>
                                                <td>29/12/2023</td>
                                            </tr>
                                            <tr>
                                                <th>widget</th>
                                                <td>400(gm)</td>
                                            </tr>
                                            <tr>
                                                <th>dimansion</th>
                                                <td>26x12x42</td>
                                            </tr>
                                            <tr>
                                                <th>ISBN</th>
                                                <td>98754382875234</td>
                                            </tr>
                                            <tr>
                                                <th colspan="2">Description :</th>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="border-top: 0px; padding-top:0px;">{{product.description}}</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const qtyInput = document.getElementById('cart-quantity');
                                            const femailOptions = document.getElementById('femail-options');

                                            qtyInput.addEventListener('input', function () {
                                                if (parseInt(qtyInput.value) > 3) {
                                                    femailOptions.style.display = 'flex';
                                                } else {
                                                    femailOptions.style.display = 'none';
                                                }
                                            });
                                        });
                                    </script>

<input type="number" id="cart-quantity" name="quantity" value="1" min="1" max="{{ product.stock }}" class="form-control">


                                    <div class="product-details-action">
                                        <a data-quantity="{{product.stock}}" data-product="{{product.id}}"
                                            data-action="add" id="add-to-cart-btn"
                                            class="btn-product btn-cart update-cart" style="
                                            margin-left: 17px;
                                            margin-right: 17px;
                                        "><span>add to cart</span></a>
                                    </div>

                                </div>
                            </div>


                        </div>
                    </div>
                </div>

                <aside class="col-xl-2 d-md-none d-xl-block">
                    <div class="sidebar sidebar-product">
                        <div class="widget widget-products">
                            <h4 class="widget-title">Related Product</h4>

                            <div class="products">
                                {% for product in products.object_list %}
                                <div class="product product-sm">

                                    <figure class="product-media">
                                        <a href="{{product.get_url}}">
                                            <img src="{{ product.image_1.url }}" alt="Product image"
                                                class="product-image">
                                        </a>
                                    </figure>

                                    <div class="product-body">
                                        <h3 class="product-title"><a href="{{product.get_url}}">{{ product.name }}</a></h3>
                                        <h6 class="text-muted mb-0">JEE Exam preprestion book</h6>

                                        <div class="related-product-publisher">DC Books</div>
                                        <!-- New arriwel / best seller /  -->
                                        <!-- <div>New arriwel</div> -->
                                        
                                        <div class="product-price">
                                            <span class="related-product-price">Rs {{ product.new_price }}</span>

                                            {% if product.get_discounted_price %}
                                            <span class="text-success mb-0 ml-2">{{ product.get_discounted_price.percentage }}% off</span>
                                            {% endif %}

                                            
                                        </div>
                                    </div>

                                </div>
                                {% endfor %}
                            </div>
                            <a href="{% url 'store_app:allProductListing' %}" class="btn btn-outline-dark-3"><span>View
                                    More Products</span><i class="icon-long-arrow-right"></i></a>
                        </div>

                    </div>
                </aside>
            </div>
        </div>
    </div>
</main>
            <script>
                function showWarningAlert(message, callback) {
                    Swal.fire({
                        icon: "warning",
                        title: "Warning...",
                        text: message,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            callback();
                        }
                    });
                }

                function incrementQuantity(stock) {
                    const quantityInput = document.getElementById('cart-quantity');
                    let currentQuantity = parseInt(quantityInput.value);

                    if (currentQuantity < stock) {
                        quantityInput.value = currentQuantity + 1;

                    } else {
                        showWarningAlert('There is no more stock available. If you want more, please contact us.', () => {

                        });
                        return;
                    }
                }

                function decrementQuantity() {
                    const quantityInput = document.getElementById('cart-quantity');
                    let currentQuantity = parseInt(quantityInput.value);

                    if (currentQuantity > 1) {
                        quantityInput.value = currentQuantity - 1;

                    }
                }

            </script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const addToCartBtn = document.getElementById('add-to-cart-btn');
                    const originalPosition = addToCartBtn.getBoundingClientRect().top + window.scrollY;

                    function checkSticky() {
                        if (window.scrollY + window.innerHeight < originalPosition) {
                            addToCartBtn.classList.add('sticky-btn');
                        } else {
                            addToCartBtn.classList.remove('sticky-btn');
                        }
                    }

                    window.addEventListener('scroll', checkSticky);
                    checkSticky();
                });
            </script>

            <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>

            {% endblock %}